#!/usr/bin/make -f

DESTDIR         = $(CURDIR)/debian/rubinius
BIN_DIR         = /usr/bin
LIB_DI          = /usr/lib/ruby
APP_DIR         = /usr/lib/rubinius
VENDOR_DIR      = /usr/lib/ruby/vendor_ruby
SITE_DIR        = /usr/local/lib/site_ruby
GEM_DIR         = /var/lib/gems/rubinius
MAN_DIR         = /usr/share/man/man1
INC_DIR         = /usr/include/rubinius
LLVM_CONFIG     = /usr/bin/llvm-config-3.3
RUBY            = ruby2.1
RAKE            = rake2.1
GEM             = gem2.1

CONFIGURE = \
  $(RUBY) ./configure \
    --llvm-config=$(LLVM_CONFIG) \
    --libdir=$(LIB_DIR) \
    --bindir=$(BIN_DIR) \
    --mandir=$(MAN_DIR) \
    --includedir=$(INC_DIR) \
    --vendordir=$(VENDOR_DIR) \
    --sitedir=$(SITE_DIR) \
    --gemsdir=$(GEM_DIR) \
    --appdir=$(APP_DIR) \
    --rake $(RAKE) \
    --gem $(GEM) \
    --preserve-prefix \
    --release-build

%:
	dh $@

override_dh_auto_configure:
	# /usr/include/double-conversion/utils.h:299:16: error: typedef ‘VerifySizesAreEqual’ locally defined but not used [-Werror=unused-local-typedefs]	
	export CXXFLAGS="-Wno-error=unused-local-typedefs" && $(CONFIGURE)

override_dh_auto_build:
	$(RAKE) build

override_dh_auto_install:
	DESTDIR=$(DESTDIR) $(RAKE) install

	for program in $$(find debian/rubinius/usr/bin -not -type d -and -not -name rbx); do \
		mv $$program $$program-rbx; \
	done

	# install manpage
	mkdir -p $(DESTDIR)/usr/share/man/man1
	pod2man --center "" --release "" --name Rubinius --utf8 debian/rubinius.1.pod $(DESTDIR)/usr/share/man/man1/rbx.1

	# install docs
	mkdir -p debian/rubinius-doc/usr/share/doc/rubinius
	cp -dpR web debian/rubinius-doc/usr/share/doc/rubinius/html

override_dh_auto_clean: override_dh_auto_configure
	dh_auto_clean
	$(RAKE) distclean
	$(RM) vendor/*.data
	for dir in vendor/* lib/tooling/profiler; do (cd $$dir ; make clean || true; make distclean || true); done

override_dh_clean:
	dh_clean --exclude=vendor/libgdtoa/makefile.orig
	$(RM) config.rb

# vim: ts=8 sw=8 noexpandtab
